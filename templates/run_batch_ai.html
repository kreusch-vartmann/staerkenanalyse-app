{% extends 'base.html' %}

{% block title %}KI-Analyse konfigurieren{% endblock %}

{% block content %}
<h2 class="text-3xl font-bold text-gray-800 mb-2">Analyse für Gruppe: {{ group.name }}</h2>
<p class="text-gray-600 mb-6">Konfigurieren Sie hier die KI-Analyse für die ausgewählten Teilnehmer.</p>

<form action="{{ url_for('analysis.execute_batch_ai_analysis') }}" method="post" enctype="multipart/form-data">
    
    <div class="mb-8 p-6 bg-white border border-gray-200 rounded-lg shadow">
        <h3 class="text-xl font-semibold mb-4">Analyse wird für folgende {{ participants|length }} Teilnehmer ausgeführt:</h3>
        <ul class="list-disc list-inside text-gray-700">
            {% for p in participants %}
                <li>{{ p.name }}</li>
                <input type="hidden" name="participant_ids" value="{{ p.id }}">
            {% endfor %}
        </ul>
    </div>

    <div class="mb-8 p-6 bg-white border border-gray-200 rounded-lg shadow">
        <h3 class="text-xl font-semibold mb-4">Einstellungen</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="prompt_selection" class="block text-sm font-medium text-gray-700">Prompt-Vorlage</label>
                <select id="prompt_selection" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">-- Bitte eine Vorlage wählen --</option>
                    {% for prompt in prompts %}
                        <option value="{{ prompt.id }}">{{ prompt.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="ki_model" class="block text-sm font-medium text-gray-700">KI-Modell</label>
                <select id="ki_model" name="ki_model" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="mistral">Mistral (Empfohlen)</option>
                    <option value="gemini">Google Gemini</option>
                </select>
            </div>
        </div>

        <div class="mt-6">
            <label for="ki_prompt" class="block text-sm font-medium text-gray-700">Prompt-Inhalt</label>
            <textarea name="ki_prompt" id="ki_prompt" rows="15" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"></textarea>
            <p class="mt-1 text-xs text-gray-500">Der Inhalt wird automatisch geladen, kann aber hier vor der Analyse noch angepasst werden.</p>
        </div>

        <div class="mt-6">
            <label for="additional_files" class="block mb-2 text-sm font-medium text-gray-900">Optionale Zusatzdatei(en) (STRG/CMD zum Mehrfachauswählen)</label>
            <input name="additional_files" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none" id="additional_files" type="file" multiple>
        </div>
    </div>

    <div class="mt-8">
        <button type="submit" class="w-full md:w-auto py-3 px-8 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold text-lg">
            <i class="fas fa-brain me-2"></i>Analysen jetzt für alle ausführen
        </button>
    </div>
</form>

<script>
    document.getElementById('prompt_selection').addEventListener('change', async function() {
        const promptId = this.value;
        const promptTextarea = document.getElementById('ki_prompt');
        if (!promptId) {
            promptTextarea.value = '';
            return;
        }

        try {
            const response = await fetch(`{{ url_for('prompts.get_prompt_content_api', prompt_id=0) }}`.slice(0, -1) + promptId);
            const data = await response.json();
            if (data.content) {
                promptTextarea.value = data.content;
            }
        } catch (error) {
            console.error('Fehler beim Laden des Prompts:', error);
            promptTextarea.value = 'Fehler: Prompt konnte nicht geladen werden.';
        }
    });
</script>
{% endblock %}