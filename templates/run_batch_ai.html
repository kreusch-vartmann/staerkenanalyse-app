{% extends 'base.html' %}

{% block title %}KI-Analyse konfigurieren{% endblock %}

{% block content %}
<h2 class="text-3xl font-bold text-gray-800 mb-2">Analyse für Gruppe: {{ group.name }}</h2>
<p class="text-gray-600 mb-6">Konfigurieren Sie hier die KI-Analyse für die ausgewählten Teilnehmer.</p>

<form action="{{ url_for('execute_batch_ai_analysis') }}" method="post" enctype="multipart/form-data">
    
    <div class="mb-8 p-6 bg-white border border-gray-200 rounded-lg shadow">
        <h3 class="text-xl font-semibold mb-4">Analyse wird für folgende {{ participants|length }} Teilnehmer ausgeführt:</h3>
        <ul class="list-disc list-inside text-gray-700">
            {% for p in participants %}
                <li>{{ p.name }}</li>
                <input type="hidden" name="participant_ids" value="{{ p.id }}">
            {% endfor %}
        </ul>
    </div>

    <div class="mb-8 p-6 bg-white border border-gray-200 rounded-lg shadow">
        <h3 class="text-xl font-semibold mb-4">Einstellungen</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="ki_model" class="block mb-2 text-sm font-medium text-gray-900">KI-Modell auswählen</label>
                <select id="ki_model" name="ki_model" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    <option value="mistral" selected>Mistral (Empfohlen)</option>
                    <option value="google">Google Gemini</option>
                </select>
            </div>
            <div>
                <label for="prompt-select" class="block mb-2 text-sm font-medium text-gray-900">Prompt-Vorlage auswählen</label>
                <select id="prompt-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    <option value="" selected>Bitte Vorlage wählen...</option>
                    {% for prompt_file in prompts %}
                        <option value="{{ prompt_file }}">{{ prompt_file }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="mt-6">
            <label for="ki_prompt" class="block mb-2 text-sm font-medium text-gray-900">KI-Prompt</label>
            <textarea id="ki_prompt" name="ki_prompt" rows="12" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Prompt wird nach Auswahl einer Vorlage geladen..."></textarea>
        </div>

        <div class="mt-6">
            <label for="additional_files" class="block mb-2 text-sm font-medium text-gray-900">Optionale Zusatzdatei(en) (STRG/CMD zum Mehrfachauswählen)</label>
            <input name="additional_files" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none" id="additional_files" type="file" multiple>
        </div>
    </div>

    <div class="mt-8">
        <button type="submit" class="w-full md:w-auto py-3 px-8 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold text-lg">
            <i class="fas fa-brain me-2"></i>Analysen jetzt für alle ausführen
        </button>
    </div>
</form>

<script>
    const promptSelect = document.getElementById('prompt-select');
    const promptTextarea = document.getElementById('ki_prompt');

    promptSelect.addEventListener('change', async (e) => {
        const filename = e.target.value;
        if (!filename) {
            promptTextarea.value = '';
            return;
        }
        promptTextarea.value = 'Lade Inhalt...';
        try {
            const response = await fetch(`/prompts/${filename}`);
            const data = await response.json();
            if (data.content) {
                promptTextarea.value = data.content;
            } else {
                promptTextarea.value = `Fehler: ${data.error}`;
            }
        } catch (error) {
            promptTextarea.value = 'Fehler beim Laden des Prompts.';
        }
    });
</script>
{% endblock %}