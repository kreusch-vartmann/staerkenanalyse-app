{% extends 'base.html' %}

{% block title %}Stärkenanalyse für {{ participant.name }}{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* Allgemeine Stile für den Bericht */
    .report-container {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #333;
    }

    /* Stile für den Druck / PDF-Export */
    @media print {
        body * {
            visibility: hidden;
        }
        #print-section, #print-section * {
            visibility: visible;
        }
        #print-section {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            margin: 0;
            padding: 0;
            border: none;
            box-shadow: none;
        }
        .no-print {
            display: none;
        }
        /* Seitenlayout für den Druck optimieren */
        @page {
            size: A4;
            margin: 2cm;
        }
        h1, h2, h3 {
            page-break-after: avoid;
        }
        section {
            page-break-inside: avoid;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="no-print mb-6 flex justify-between items-center">
    <a href="{{ url_for('show_group_participants', group_id=group.id) }}" class="py-2 px-4 text-sm rounded-lg bg-gray-200 hover:bg-gray-300 font-semibold">
        ← Zurück zur Gruppenübersicht
    </a>
    <div>
        <button onclick="saveReport()" class="py-2 px-4 text-sm rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700">Bericht speichern</button>
        <button onclick="window.print()" class="py-2 px-4 text-sm rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700">Drucken / PDF</button>
    </div>
</div>

<div id="print-section" class="report-container max-w-4xl mx-auto bg-white p-8 sm:p-12 shadow-lg rounded-lg border">
    <!-- Header -->
    <header class="text-center mb-12">
        <h1 class="text-4xl font-bold text-gray-800">Stärkenanalyse</h1>
        <p class="text-xl text-gray-600" contenteditable="true" id="participant-name">{{ participant.name }}</p>
    </header>

    <!-- Allgemeine Daten -->
    <section class="mb-10 text-sm">
        <div class="grid grid-cols-2 gap-x-8 gap-y-2">
            <div><strong>Datum:</strong> <span contenteditable="true" id="general-date">{{ (participant.general_data or {}).date | default(group.date, true) | datetimeformat }}</span></div>
            <div><strong>Leitung:</strong> <span contenteditable="true" id="general-leitung">{{ group.leitung }}</span></div>
            <div><strong>Ort:</strong> <span contenteditable="true" id="general-location">{{ (participant.general_data or {}).location | default(group.location, true) }}</span></div>
            <div><strong>Beobachter:</strong> <span contenteditable="true" id="general-beobachter">{{ group.beobachter1 }}{% if group.beobachter2 %}, {{ group.beobachter2 }}{% endif %}</span></div>
        </div>
    </section>

    <!-- Soziale Kompetenzen -->
    <section class="mb-12">
        <h2 class="text-2xl font-semibold text-gray-700 border-b-2 border-indigo-500 pb-2 mb-6">Soziale Kompetenzen</h2>
        <div class="grid md:grid-cols-2 gap-8 items-start">
            <div class="prose max-w-none text-gray-700" contenteditable="true" id="social-text">
                {{ ((participant.ki_texts or {}).social_text or 'Hier Text für soziale Kompetenzen einfügen...')|safe }}
            </div>
            <div>
                <canvas id="skChart"></canvas>
                <!-- Interaktive Schieberegler -->
                <div class="mt-6 space-y-4 no-print">
                    <div class="grid grid-cols-6 items-center gap-2">
                        <label for="sk_flex" class="col-span-2 text-sm font-medium text-gray-700">Flexibilität</label>
                        <input type="range" id="sk_flex" min="0" max="10" step="0.5" value="{{ (participant.sk_ratings or {}).flexibility or 0 }}" oninput="updateValueAndChart(skChart, 0, this.value, 'sk_flex_val')" class="col-span-3 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="sk_flex_val" class="col-span-1 text-center text-sm font-semibold text-gray-800">{{ "%.1f"|format((participant.sk_ratings or {}).flexibility or 0) }}</span>
                    </div>
                    <div class="grid grid-cols-6 items-center gap-2">
                        <label for="sk_team" class="col-span-2 text-sm font-medium text-gray-700">Teamorientierung</label>
                        <input type="range" id="sk_team" min="0" max="10" step="0.5" value="{{ (participant.sk_ratings or {}).team_orientation or 0 }}" oninput="updateValueAndChart(skChart, 1, this.value, 'sk_team_val')" class="col-span-3 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="sk_team_val" class="col-span-1 text-center text-sm font-semibold text-gray-800">{{ "%.1f"|format((participant.sk_ratings or {}).team_orientation or 0) }}</span>
                    </div>
                    <div class="grid grid-cols-6 items-center gap-2">
                        <label for="sk_proc" class="col-span-2 text-sm font-medium text-gray-700">Prozessorient.</label>
                        <input type="range" id="sk_proc" min="0" max="10" step="0.5" value="{{ (participant.sk_ratings or {}).process_orientation or 0 }}" oninput="updateValueAndChart(skChart, 2, this.value, 'sk_proc_val')" class="col-span-3 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="sk_proc_val" class="col-span-1 text-center text-sm font-semibold text-gray-800">{{ "%.1f"|format((participant.sk_ratings or {}).process_orientation or 0) }}</span>
                    </div>
                    <div class="grid grid-cols-6 items-center gap-2">
                        <label for="sk_res" class="col-span-2 text-sm font-medium text-gray-700">Ergebnisorient.</label>
                        <input type="range" id="sk_res" min="0" max="10" step="0.5" value="{{ (participant.sk_ratings or {}).results_orientation or 0 }}" oninput="updateValueAndChart(skChart, 3, this.value, 'sk_res_val')" class="col-span-3 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="sk_res_val" class="col-span-1 text-center text-sm font-semibold text-gray-800">{{ "%.1f"|format((participant.sk_ratings or {}).results_orientation or 0) }}</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Verbale Kompetenzen -->
    <section class="mb-12">
        <h2 class="text-2xl font-semibold text-gray-700 border-b-2 border-indigo-500 pb-2 mb-6">Verbale Kompetenzen</h2>
        <div class="grid md:grid-cols-2 gap-8 items-start">
            <div class="prose max-w-none text-gray-700" contenteditable="true" id="verbal-text">
                {{ ((participant.ki_texts or {}).verbal_text or 'Hier Text für verbale Kompetenzen einfügen...')|safe }}
            </div>
            <div>
                <canvas id="vkChart"></canvas>
                <!-- Interaktive Schieberegler -->
                <div class="mt-6 space-y-4 no-print">
                    <div class="grid grid-cols-6 items-center gap-2">
                        <label for="vk_flex" class="col-span-2 text-sm font-medium text-gray-700">Flexibilität</label>
                        <input type="range" id="vk_flex" min="0" max="10" step="0.5" value="{{ (participant.vk_ratings or {}).flexibility or 0 }}" oninput="updateValueAndChart(vkChart, 0, this.value, 'vk_flex_val')" class="col-span-3 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="vk_flex_val" class="col-span-1 text-center text-sm font-semibold text-gray-800">{{ "%.1f"|format((participant.vk_ratings or {}).flexibility or 0) }}</span>
                    </div>
                    <div class="grid grid-cols-6 items-center gap-2">
                        <label for="vk_cons" class="col-span-2 text-sm font-medium text-gray-700">Beratung</label>
                        <input type="range" id="vk_cons" min="0" max="10" step="0.5" value="{{ (participant.vk_ratings or {}).consulting or 0 }}" oninput="updateValueAndChart(vkChart, 1, this.value, 'vk_cons_val')" class="col-span-3 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="vk_cons_val" class="col-span-1 text-center text-sm font-semibold text-gray-800">{{ "%.1f"|format((participant.vk_ratings or {}).consulting or 0) }}</span>
                    </div>
                    <div class="grid grid-cols-6 items-center gap-2">
                        <label for="vk_obj" class="col-span-2 text-sm font-medium text-gray-700">Objektivität</label>
                        <input type="range" id="vk_obj" min="0" max="10" step="0.5" value="{{ (participant.vk_ratings or {}).objectivity or 0 }}" oninput="updateValueAndChart(vkChart, 2, this.value, 'vk_obj_val')" class="col-span-3 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="vk_obj_val" class="col-span-1 text-center text-sm font-semibold text-gray-800">{{ "%.1f"|format((participant.vk_ratings or {}).objectivity or 0) }}</span>
                    </div>
                    <div class="grid grid-cols-6 items-center gap-2">
                        <label for="vk_goal" class="col-span-2 text-sm font-medium text-gray-700">Zielorientierung</label>
                        <input type="range" id="vk_goal" min="0" max="10" step="0.5" value="{{ (participant.vk_ratings or {}).goal_orientation or 0 }}" oninput="updateValueAndChart(vkChart, 3, this.value, 'vk_goal_val')" class="col-span-3 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="vk_goal_val" class="col-span-1 text-center text-sm font-semibold text-gray-800">{{ "%.1f"|format((participant.vk_ratings or {}).goal_orientation or 0) }}</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Zusammenfassung -->
    <section class="mb-12">
        <h2 class="text-2xl font-semibold text-gray-700 border-b-2 border-indigo-500 pb-2 mb-6">Zusammenfassung</h2>
        <div class="prose max-w-none text-gray-700" contenteditable="true" id="summary-text">
            {{ ((participant.ki_texts or {}).summary_text or 'Hier Zusammenfassung einfügen...')|safe }}
        </div>
    </section>
    
    <!-- Footer -->
    <footer class="mt-16 pt-6 border-t text-xs text-gray-500">
        <div class="grid grid-cols-3 gap-4">
            <span>{{ group.leitung }}</span>
            <span class="text-center">Lingen (Ems), den {{ current_date|datetimeformat('%d.%m.%Y') }}</span>
            <span class="text-right">Stärkenanalyse</span>
        </div>
    </footer>
</div>

<script>
    let skChart, vkChart;

    const initial_sk_ratings = {{ (participant.sk_ratings or {"flexibility": 0, "team_orientation": 0, "process_orientation": 0, "results_orientation": 0})|tojson|safe }};
    const initial_vk_ratings = {{ (participant.vk_ratings or {"flexibility": 0, "consulting": 0, "objectivity": 0, "goal_orientation": 0})|tojson|safe }};

    const chartOptions = {
        type: 'radar',
        options: {
            scales: {
                r: {
                    angleLines: { color: 'rgba(0, 0, 0, 0.1)' },
                    grid: { color: 'rgba(0, 0, 0, 0.1)' },
                    pointLabels: { font: { size: 12 } },
                    suggestedMin: 0,
                    suggestedMax: 10,
                    ticks: { stepSize: 2, backdropColor: 'transparent' }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    };

    // Chart für Soziale Kompetenzen
    const skConfig = {
        type: 'radar',
        options: chartOptions.options,
        data: {
            labels: ['Flexibilität', 'Teamorientierung', 'Prozessorientierung', 'Ergebnisorientierung'],
            datasets: [{
                label: 'Soziale Kompetenzen',
                data: [initial_sk_ratings.flexibility, initial_sk_ratings.team_orientation, initial_sk_ratings.process_orientation, initial_sk_ratings.results_orientation],
                fill: true,
                backgroundColor: 'rgba(79, 70, 229, 0.2)',
                borderColor: 'rgb(79, 70, 229)',
                pointBackgroundColor: 'rgb(79, 70, 229)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgb(79, 70, 229)'
            }]
        }
    };
    skChart = new Chart(document.getElementById('skChart'), skConfig);

    // Chart für Verbale Kompetenzen
    const vkConfig = {
        type: 'radar',
        options: chartOptions.options,
        data: {
            labels: ['Flexibilität', 'Beratung', 'Objektivität', 'Zielorientierung'],
            datasets: [{
                label: 'Verbale Kompetenzen',
                data: [initial_vk_ratings.flexibility, initial_vk_ratings.consulting, initial_vk_ratings.objectivity, initial_vk_ratings.goal_orientation],
                fill: true,
                backgroundColor: 'rgba(34, 197, 94, 0.2)',
                borderColor: 'rgb(34, 197, 94)',
                pointBackgroundColor: 'rgb(34, 197, 94)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgb(34, 197, 94)'
            }]
        }
    };
    vkChart = new Chart(document.getElementById('vkChart'), vkConfig);

    function updateValueAndChart(chart, dataIndex, value, spanId) {
        document.getElementById(spanId).textContent = parseFloat(value).toFixed(1);
        chart.data.datasets[0].data[dataIndex] = parseFloat(value);
        chart.update();
    }

    // Wandelt ein Datum im Format TT.MM.JJJJ in das Format JJJJ-MM-TT um
    function convertDateToISO(dateString) {
        const parts = dateString.match(/(\d{2})\.(\d{2})\.(\d{4})/);
        if (parts) {
            return `${parts[3]}-${parts[2]}-${parts[1]}`;
        }
        return dateString; // Fallback, falls das Format unerwartet ist
    }

    async function saveReport() {
        const current_sk_ratings = {
            flexibility: parseFloat(document.getElementById('sk_flex').value),
            team_orientation: parseFloat(document.getElementById('sk_team').value),
            process_orientation: parseFloat(document.getElementById('sk_proc').value),
            results_orientation: parseFloat(document.getElementById('sk_res').value)
        };
        const current_vk_ratings = {
            flexibility: parseFloat(document.getElementById('vk_flex').value),
            consulting: parseFloat(document.getElementById('vk_cons').value),
            objectivity: parseFloat(document.getElementById('vk_obj').value),
            goal_orientation: parseFloat(document.getElementById('vk_goal').value)
        };

        const reportData = {
            name: document.getElementById('participant-name').innerText,
            general_data: {
                date: convertDateToISO(document.getElementById('general-date').innerText),
                location: document.getElementById('general-location').innerText,
                observers: document.getElementById('general-beobachter').innerText
            },
            ki_texts: {
                social_text: document.getElementById('social-text').innerHTML,
                verbal_text: document.getElementById('verbal-text').innerHTML,
                summary_text: document.getElementById('summary-text').innerHTML
            },
            sk_ratings: current_sk_ratings,
            vk_ratings: current_vk_ratings
        };

        try {
            const response = await fetch(`{{ url_for('save_report', participant_id=participant.id) }}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(reportData)
            });
            const result = await response.json();
            showToast(result.message, result.status);
        } catch (error) {
            showToast('Fehler beim Speichern des Berichts.', 'error');
        }
    }
</script>
{% endblock %}

