{% extends 'base.html' %}

{% block title %}Bericht bearbeiten: {{ participant.name }}{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="flex items-center justify-end flex-wrap gap-2">
    <button onclick="openModal()" class="py-2 px-5 rounded-md text-white bg-gray-600 hover:bg-gray-700 font-semibold">
        <i class="fas fa-eye me-2"></i>Beobachtungen
    </button>

<a href="{{ url_for('analysis.ai_analysis_select_participants', group_id=group.id) }}" class="py-2 px-5 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold">        <i class="fas fa-robot me-2"></i>NEU!
    </a>

    <button onclick="saveReport()" class="py-2 px-5 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold">
        <i class="fas fa-save me-2"></i>Änderungen speichern
    </button>

    <button onclick="downloadPDF()" class="py-2 px-5 rounded-md text-white bg-red-600 hover:bg-red-700 font-semibold">
        <i class="fas fa-file-pdf me-2"></i>PDF erstellen
    </button>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-x-6 gap-y-8">

    <div class="bg-white p-6 shadow-md rounded-lg">
        <h3 class="text-xl font-bold text-gray-700 mb-4">Soziale Kompetenzen: Bewertung</h3>
        <div class="chart-container-large mx-auto mb-6">
            <canvas id="skRadarChart"></canvas>
        </div>
        <div id="sk-sliders" class="space-y-4"></div>
    </div>

    <div class="bg-white p-6 shadow-md rounded-lg">
        <h3 class="text-xl font-bold text-gray-700 mb-4">Verbale Kompetenzen: Bewertung</h3>
        <div class="chart-container-large mx-auto mb-6">
            <canvas id="vkRadarChart"></canvas>
        </div>
        <div id="vk-sliders" class="space-y-4"></div>
    </div>

    <div class="bg-white p-6 shadow-md rounded-lg">
        <h3 class="text-xl font-bold text-gray-700 mb-4">Text: Soziale Kompetenzen</h3>
        <textarea id="social_text" class="w-full h-48 p-3 border rounded-md focus:ring-2 focus:ring-blue-500 transition-shadow">{{ (participant.ki_texts or {}).social_text }}</textarea>
    </div>

    <div class="bg-white p-6 shadow-md rounded-lg">
        <h3 class="text-xl font-bold text-gray-700 mb-4">Text: Verbale Kompetenzen</h3>
        <textarea id="verbal_text" class="w-full h-48 p-3 border rounded-md focus:ring-2 focus:ring-blue-500 transition-shadow">{{ (participant.ki_texts or {}).verbal_text }}</textarea>
    </div>

    <div class="bg-white p-6 shadow-md rounded-lg">
        <h3 class="text-xl font-bold text-gray-700 mb-4">Text: Zusammenfassung</h3>
        <textarea id="summary_text" class="w-full h-32 p-3 border rounded-md focus:ring-2 focus:ring-blue-500 transition-shadow">{{ (participant.ki_texts or {}).summary_text }}</textarea>
    </div>

    <div class="space-y-6">
        <div class="bg-white p-6 shadow-md rounded-lg">
            <h3 class="text-xl font-bold text-gray-700 mb-4">PDF-Rahmendaten</h3>
            <div class="space-y-3 text-sm metadata">
                <p><strong>Durchführungsdatum:</strong> <span contenteditable="true" data-key="date" class="editable-field">{{ group.date | datetimeformat }}</span></p>
                <p><strong>Durchführungsort:</strong> <span contenteditable="true" data-key="location" class="editable-field">{{ group.location }}</span></p>
                <p><strong>Leitung:</strong> <span contenteditable="true" data-key="leitung" class="editable-field">{{ group.leitung }}</span></p>
                <p><strong>Beobachter 1:</strong> <span contenteditable="true" data-key="beobachter1" class="editable-field">{{ group.beobachter1 }}</span></p>
                <p><strong>Beobachter 2:</strong> <span contenteditable="true" data-key="beobachter2" class="editable-field">{{ group.beobachter2 }}</span></p>
            </div>
        </div>
        <div class="bg-white p-6 shadow-md rounded-lg">
            <h3 class="text-xl font-bold text-gray-700 mb-4">PDF-Fußzeile</h3>
            <div class="space-y-3 text-sm main-content-footer">
                <p><strong>Unterschriftszeile:</strong> <span contenteditable="true" data-key="footer_line1" class="editable-field">{{ (participant.footer_data or {}).footer_line1 or 'Timo Kreusch-Vartmann' }}</span></p>
                <p><strong>Ort:</strong> <span contenteditable="true" data-key="footer_location" class="editable-field">{{ (participant.footer_data or {}).footer_location or current_location }}</span></p>
                <p><strong>Datum:</strong> <span contenteditable="true" data-key="footer_date" class="editable-field">{{ (participant.footer_data or {}).footer_date or current_date }}</span></p>
            </div>
        </div>
    </div>

</div>

<style>
    .chart-container-large {
        position: relative;
        height: 300px;
        width: 100%;
        max-width: 350px;
    }
    .editable-field {
        padding: 2px 6px;
        border-radius: 4px;
        background-color: #f7fafc;
        border: 1px solid transparent;
        transition: all 0.2s ease-in-out;
    }
    .editable-field:hover {
        background-color: #edf2f7;
    }
    .editable-field:focus {
        outline: none;
        border-color: #4299e1;
        background-color: white;
        box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5);
    }
</style>

<div id="observationsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-2xl max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-2xl font-bold text-gray-800">Beobachtungen für {{ participant.name }}</h3>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
        </div>

        <div class="p-6 overflow-y-auto">
            {% if participant.observations and (participant.observations.social or participant.observations.verbal) %}
                <dl class="space-y-4">
                    {% if participant.observations.social %}
                    <div>
                        <dt class="font-semibold text-gray-700 text-lg">Beobachtungen (Soziale Kompetenzen)</dt>
                        <dd class="text-gray-600 mt-1 pl-4 border-l-2 border-gray-200 whitespace-pre-wrap">{{ participant.observations.social }}</dd>
                    </div>
                    {% endif %}

                    {% if participant.observations.verbal %}
                    <div>
                        <dt class="font-semibold text-gray-700 text-lg">Beobachtungen (Verbale Kompetenzen)</dt>
                        <dd class="text-gray-600 mt-1 pl-4 border-l-2 border-gray-200 whitespace-pre-wrap">{{ participant.observations.verbal }}</dd>
                    </div>
                    {% endif %}
                </dl>
            {% else %}
                <p class="text-gray-500">Keine Beobachtungen für diesen Teilnehmer vorhanden.</p>
            {% endif %}
        </div>

        <div class="flex justify-end p-4 border-t bg-gray-50 rounded-b-lg">
            <button onclick="closeModal()" class="py-2 px-5 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold">
                Schließen
            </button>
        </div>
    </div>
</div>

<script>
    // =================================================================================
    // KOMPLETTER, BEREINIGTER JAVASCRIPT-BLOCK
    // =================================================================================

    // ---------------------------------------------------------------------------------
    // 1. DATEN UND VARIABLEN FÜR DIAGRAMME
    // ---------------------------------------------------------------------------------
    let sk_ratings = {{ participant.sk_ratings | tojson | safe }};
    let vk_ratings = {{ participant.vk_ratings | tojson | safe }};
    const sk_labels = ['Flexibilität', 'Teamorientierung', 'Prozessorientierung', 'Ergebnisorientierung'];
    const vk_labels = ['Flexibilität', 'Beratung', 'Sachlichkeit', 'Zielorientierung'];
    const sk_keys = ['flexibility', 'team_orientation', 'process_orientation', 'results_orientation'];
    const vk_keys = ['flexibility', 'consulting', 'objectivity', 'goal_orientation'];
    const chartOptions = { scales: { r: { suggestedMin: 0, suggestedMax: 10, pointLabels: { font: { size: 12 } }, ticks: { display: false } } }, plugins: { legend: { display: false } }, maintainAspectRatio: false };
    const skDataset = { label: 'Bewertung', data: sk_keys.map(k => sk_ratings[k]), fill: true, backgroundColor: 'rgba(90, 125, 124, 0.2)', borderColor: 'rgba(90, 125, 124, 1)', pointRadius: 0 };
    const vkDataset = { label: 'Bewertung', data: vk_keys.map(k => vk_ratings[k]), fill: true, backgroundColor: 'rgba(47, 79, 79, 0.2)', borderColor: 'rgba(47, 79, 79, 1)', pointRadius: 0 };
    
    const skChart = new Chart(document.getElementById('skRadarChart'), { type: 'radar', data: { labels: sk_labels, datasets: [skDataset] }, options: chartOptions });
    const vkChart = new Chart(document.getElementById('vkRadarChart'), { type: 'radar', data: { labels: vk_labels, datasets: [vkDataset] }, options: chartOptions });

    let isDirty = false;

    // ---------------------------------------------------------------------------------
    // 2. FUNKTIONEN
    // ---------------------------------------------------------------------------------
    function createSliders(containerId, keys, labels, ratings, chartInstance, dataset, prefix) {
        const container = document.getElementById(containerId);
        keys.forEach((key, index) => {
            const value = ratings[key] || 0;
            const sliderDiv = document.createElement('div');
            const sliderId = `${prefix}_${key}-slider`;
            const valueId = `${prefix}_${key}-value`;

            sliderDiv.innerHTML = `<label for="${sliderId}" class="block text-sm font-medium text-gray-700">${labels[index]}</label><div class="flex items-center space-x-2"><input type="range" id="${sliderId}" min="0" max="10" value="${value}" step="0.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"><span id="${valueId}" class="font-semibold w-10 text-center text-sm">${value.toFixed(1)}</span></div>`;
            container.appendChild(sliderDiv);
            
            const slider = document.getElementById(sliderId);
            slider.addEventListener('input', (e) => {
                isDirty = true;
                const newValue = parseFloat(e.target.value);
                document.getElementById(valueId).textContent = newValue.toFixed(1);
                ratings[key] = newValue;
                dataset.data = keys.map(k => ratings[k]);
                chartInstance.update();
            });
        });
    }

    async function saveReport() {
        const groupDetails = {};
        document.querySelectorAll('.metadata [data-key]').forEach(el => { groupDetails[el.dataset.key] = el.textContent; });
        
        const footerData = {};
        document.querySelectorAll('.main-content-footer [data-key]').forEach(el => { footerData[el.dataset.key] = el.textContent; });
        
        const reportData = {
            sk_ratings: sk_ratings, 
            vk_ratings: vk_ratings,
            ki_texts: { 
                social_text: document.getElementById('social_text').value, 
                verbal_text: document.getElementById('verbal_text').value, 
                summary_text: document.getElementById('summary_text').value 
            },
            group_details: groupDetails, 
            footer_data: footerData
        };
        
        try {
            const response = await fetch("{{ url_for('participants.save_report', participant_id=participant.id) }}", { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(reportData) 
            });
            const result = await response.json();
            alert(result.message);
            isDirty = false;
        } catch (error) { 
            console.error('Save error:', error); 
            alert('Fehler beim Speichern des Berichts.'); 
        }
    }

    async function downloadPDF() {
        if (isDirty) {
            if (confirm("Sie haben ungespeicherte Änderungen. Möchten Sie vor dem Erstellen der PDF speichern?")) {
                await saveReport();
            }
        }
        // Leitet den Browser zur PDF-Route weiter, was den Download auslöst
        window.location.href = "{{ url_for('analysis.bericht_pdf', participant_id=participant.id) }}";
    }

    // ---------------------------------------------------------------------------------
    // 3. FUNKTIONEN FÜR MODAL
    // ---------------------------------------------------------------------------------
    const modal = document.getElementById('observationsModal');

    function openModal() {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeModal() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
    
    // ---------------------------------------------------------------------------------
    // 4. EVENT LISTENERS UND INITIALISIERUNG
    // ---------------------------------------------------------------------------------
    createSliders('sk-sliders', sk_keys, sk_labels, sk_ratings, skChart, skDataset, 'sk');
    createSliders('vk-sliders', vk_keys, vk_labels, vk_ratings, vkChart, vkDataset, 'vk');

    document.querySelectorAll('textarea, [contenteditable="true"]').forEach(item => {
        item.addEventListener('input', () => { isDirty = true; });
    });

    window.addEventListener('beforeunload', (event) => {
        if (isDirty) {
            event.preventDefault();
            event.returnValue = '';
        }
    });
</script>
{% endblock %}