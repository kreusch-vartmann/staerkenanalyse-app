{% extends 'base.html' %}

{% block title %}St√§rkenanalyse f√ºr {{ participant.name }}{% endblock %}

{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Source+Serif+Pro:wght@400;700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<div id="report-container">
    <div class="flex justify-between items-start mb-6 no-print">
        <div>
            <h2 class="text-3xl font-bold text-gray-800">St√§rkenanalyse-Bericht</h2>
            <p class="text-xl text-gray-600 font-semibold">{{ participant.name }}</p>
        </div>
        <div>
            <button onclick="saveReport()" class="py-2 px-5 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold mr-2">
                <i class="fas fa-save me-2"></i>√Ñnderungen speichern
            </button>
            <button onclick="downloadPDF()" class="py-2 px-5 rounded-md text-white bg-red-600 hover:bg-red-700 font-semibold">
                <i class="fas fa-file-pdf me-2"></i>Als PDF speichern
            </button>
        </div>
    </div>

    <div id="report-content" class="bg-white shadow-md rounded-lg">
        
        <div class="pdf-page">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <div class="logo">üîç</div>
                    <h1 class="main-title">St√§rkenanalyse f√ºr<br><span class="participant-name">{{ participant.name }}</span></h1>
                </div>
                <div class="sidebar-spacer"></div>
                <div class="metadata">
                    <h2 class="metadata-title">RAHMENDATEN</h2>
                    <p><strong>Durchf√ºhrungsdatum:</strong> <span contenteditable="true" data-key="date">{{ group.date | datetimeformat }}</span></p>
                    <p><strong>Durchf√ºhrungsort:</strong> <span contenteditable="true" data-key="location">{{ group.location }}</span></p>
                    <p><strong>Leitung:</strong> <span contenteditable="true" data-key="leitung">{{ group.leitung }}</span></p>
                    <p><strong>Beobachter:</strong> <span contenteditable="true" data-key="beobachter1">{{ group.beobachter1 }}</span>, <span contenteditable="true" data-key="beobachter2">{{ group.beobachter2 }}</span></p>
                </div>
                <div class="sidebar-footer">
                    <p>Seite <span class="page-number">1</span> von 2</p>
                </div>
            </aside>
            <main class="main-content">
                <h2 class="subtitle">Soziale Kompetenz & Verbale Kompetenz</h2>
                <section class="content-section">
                    <h3 class="section-title">Soziale Kompetenzen</h3>
                    <textarea id="social_text" class="text-area-input">{{ (participant.ki_texts or {}).social_text }}</textarea>
                    <div class="chart-container">
                        <canvas id="skRadarChart"></canvas>
                    </div>
                    <div id="sk-sliders" class="space-y-3 mt-6 no-print max-w-md mx-auto"></div>
                </section>
                <div class="footer-spacer"></div>
            </main>
        </div>

        <div class="pdf-page">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <div class="logo">üîç</div>
                </div>
                <div class="sidebar-spacer"></div>
                 <div class="sidebar-footer">
                    <p>Seite <span class="page-number">2</span> von 2</p>
                </div>
            </aside>
            <main class="main-content">
                <section class="content-section">
                    <h3 class="section-title">Verbale Kompetenzen</h3>
                    <textarea id="verbal_text" class="text-area-input">{{ (participant.ki_texts or {}).verbal_text }}</textarea>
                    <div class="chart-container">
                        <canvas id="vkRadarChart"></canvas>
                    </div>
                    <div id="vk-sliders" class="space-y-3 mt-6 no-print max-w-md mx-auto"></div>
                </section>
                <section class="content-section">
                    <h3 class="section-title">Zusammenfassung</h3>
                    <textarea id="summary_text" class="text-area-input">{{ (participant.ki_texts or {}).summary_text }}</textarea>
                </section>
                <div class="footer-spacer"></div>
                <footer class="main-content-footer">
                    <span contenteditable="true" data-key="footer_line1">{{ (participant.footer_data or {}).footer_line1 or 'Timo Kreusch-Vartmann' }}</span>
                    <span>
                        <span contenteditable="true" data-key="footer_location">{{ (participant.footer_data or {}).footer_location or current_location }}</span>, den
                        <span contenteditable="true" data-key="footer_date">{{ (participant.footer_data or {}).footer_date or current_date }}</span>
                    </span>
                </footer>
            </main>
        </div>
    </div>
</div>

<script>
    // Kompletter, funktionierender JavaScript-Block
    let sk_ratings = {{ participant.sk_ratings | tojson | safe }};
    let vk_ratings = {{ participant.vk_ratings | tojson | safe }};
    const sk_labels = ['Flexibilit√§t', 'Teamorientierung', 'Prozessorientierung', 'Ergebnisorientierung'];
    const vk_labels = ['Flexibilit√§t', 'Beratung', 'Sachlichkeit', 'Zielorientierung'];
    const sk_keys = ['flexibility', 'team_orientation', 'process_orientation', 'results_orientation'];
    const vk_keys = ['flexibility', 'consulting', 'objectivity', 'goal_orientation'];
    const chartOptions = { scales: { r: { suggestedMin: 0, suggestedMax: 10, pointLabels: { font: { size: 12, family: 'Montserrat' } }, ticks: { display: false } } }, plugins: { legend: { display: false } }, maintainAspectRatio: false };
    const skDataset = { label: 'Bewertung', data: sk_keys.map(k => sk_ratings[k]), fill: true, backgroundColor: 'rgba(90, 125, 124, 0.2)', borderColor: 'rgba(90, 125, 124, 1)', pointRadius: 0 };
    const vkDataset = { label: 'Bewertung', data: vk_keys.map(k => vk_ratings[k]), fill: true, backgroundColor: 'rgba(47, 79, 79, 0.2)', borderColor: 'rgba(47, 79, 79, 1)', pointRadius: 0 };
    const skChart = new Chart(document.getElementById('skRadarChart'), { type: 'radar', data: { labels: sk_labels, datasets: [skDataset] }, options: chartOptions });
    const vkChart = new Chart(document.getElementById('vkRadarChart'), { type: 'radar', data: { labels: vk_labels, datasets: [vkDataset] }, options: chartOptions });
    function createSliders(containerId, keys, labels, ratings, chartInstance, dataset) {
        const container = document.getElementById(containerId);
        keys.forEach((key, index) => {
            const value = ratings[key] || 0;
            const sliderDiv = document.createElement('div');
            sliderDiv.innerHTML = `<label style="font-family: 'Montserrat', sans-serif;" for="${key}-slider" class="block text-sm font-medium text-gray-700">${labels[index]}</label><div class="flex items-center space-x-3"><input type="range" id="${key}-slider" min="0" max="10" value="${value}" step="0.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"><span id="${key}-value" class="font-semibold w-10 text-center">${value.toFixed(1)}</span></div>`;
            container.appendChild(sliderDiv);
            const slider = document.getElementById(`${key}-slider`);
            slider.addEventListener('input', (e) => {
                const newValue = parseFloat(e.target.value);
                document.getElementById(`${key}-value`).textContent = newValue.toFixed(1);
                ratings[key] = newValue;
                dataset.data = keys.map(k => ratings[k]);
                chartInstance.update();
            });
        });
    }
    createSliders('sk-sliders', sk_keys, sk_labels, sk_ratings, skChart, skDataset);
    createSliders('vk-sliders', vk_keys, vk_labels, vk_ratings, vkChart, vkDataset);
    async function saveReport() {
        const groupDetails = {};
        document.querySelectorAll('.metadata [data-key]').forEach(el => { groupDetails[el.dataset.key] = el.textContent; });
        const footerData = {};
        document.querySelectorAll('.main-content-footer [data-key]').forEach(el => { footerData[el.dataset.key] = el.textContent; });
        const reportData = {
            sk_ratings: sk_ratings, vk_ratings: vk_ratings,
            ki_texts: { social_text: document.getElementById('social_text').value, verbal_text: document.getElementById('verbal_text').value, summary_text: document.getElementById('summary_text').value },
            group_details: groupDetails, footer_data: footerData
        };
        try {
            const response = await fetch("{{ url_for('save_report', participant_id=participant.id) }}", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(reportData) });
            const result = await response.json();
            alert(result.message);
        } catch (error) { console.error('Save error:', error); alert('Fehler beim Speichern des Berichts.'); }
    }
    async function downloadPDF() {
        const skChartImage = skChart.toBase64Image();
        const vkChartImage = vkChart.toBase64Image();
        const printElement = document.getElementById('report-content').cloneNode(true);
        const skCanvas = printElement.querySelector('#skRadarChart');
        if (skCanvas) { const skImg = document.createElement('img'); skImg.src = skChartImage; skCanvas.parentNode.replaceChild(skImg, skCanvas); }
        const vkCanvas = printElement.querySelector('#vkRadarChart');
        if(vkCanvas) { const vkImg = document.createElement('img'); vkImg.src = vkChartImage; vkCanvas.parentNode.replaceChild(vkImg, vkCanvas); }
        printElement.querySelectorAll('.no-print').forEach(el => el.remove());
        printElement.querySelectorAll('textarea').forEach(textarea => {
            const paragraph = document.createElement('div');
            paragraph.innerHTML = textarea.value.replace(/\n/g, '<br>');
            paragraph.className = 'text-content-for-pdf';
            textarea.parentNode.replaceChild(paragraph, textarea);
        });
        const opt = {
            margin: 0, filename: 'Staerkenanalyse_{{ participant.name | replace(" ", "_") }}.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, logging: false },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        await html2pdf().from(printElement).set(opt).save();
    }
</script>

<style>
    :root {
        --primary-color: #5A7D7C;
        --text-color: #2F4F4F;
        --font-heading: 'Montserrat', sans-serif;
        --font-body: 'Source Serif Pro', serif;
    }
    /* KORREKTUR: Feste Seitengr√∂√üe mit √úberlauf-Kontrolle */
    .pdf-page { 
        display: flex; 
        /* Feste A4-Gr√∂√üe, minus ein winziger Puffer, um Rundungsfehler zu vermeiden */
        width: 210mm;
        height: 296.9mm; 
        overflow: hidden; /* Dies ist der entscheidende Befehl: Alles, was √ºberl√§uft, wird abgeschnitten. */
    } 
    .sidebar { width: 30%; background-color: var(--primary-color); color: white; padding: 30px; display: flex; flex-direction: column; }
    .sidebar-header { flex-shrink: 0; }
    .sidebar-spacer { flex-grow: 1; }
    .logo { font-size: 2.5em; font-weight: 700; margin-bottom: 40px; }
    .main-title { font-family: var(--font-heading); font-size: 1.5em; line-height: 1.2; }
    .participant-name {
        font-size: 1.5em;
        font-weight: 700;
        
        /* NEU & KORRIGIERT: Diese Regeln sorgen f√ºr den korrekten Umbruch */
        display: block; /* Stellt sicher, dass das Element die volle Breite einnehmen kann */
        overflow-wrap: break-word; /* Erzwingt den Umbruch, wenn ein Wort zu lang ist */
        -webkit-hyphens: auto;     /* Aktiviert die Silbentrennung f√ºr Chrome/Safari */
        -ms-hyphens: auto;         /* Aktiviert die Silbentrennung f√ºr IE/Edge */
        hyphens: auto;             /* Aktiviert die Silbentrennung f√ºr Firefox/Standard */

        /* ALT: Diese Regeln k√∂nnen entfernt werden, da sie durch die oberen ersetzt werden */
        /* word-wrap: break-word; */ /* Veraltet, wird durch overflow-wrap ersetzt */
        /* max-width: 180px; */    /* Diese Beschr√§nkung ist nicht mehr n√∂tig */
    }
    .metadata { flex-shrink: 0; margin-bottom: 20px; font-size: 0.85em; line-height: 1.8; }
    .metadata-title { font-family: var(--font-heading); font-weight: 700; letter-spacing: 1px; opacity: 0.8; margin-bottom: 10px; }
    .sidebar-footer { flex-shrink: 0; font-family: var(--font-heading); opacity: 0.8; }
    .main-content { width: 70%; padding: 40px; color: var(--text-color); font-family: var(--font-body); display: flex; flex-direction: column; }
    .footer-spacer { flex-grow: 1; }
    .subtitle { font-family: var(--font-heading); color: #888; margin-bottom: 40px; text-align: center; }
    .content-section { margin-bottom: 40px; }
    .section-title { font-family: var(--font-heading); font-size: 1.6em; font-weight: 700; color: var(--primary-color); margin-bottom: 15px; }
    .text-area-input { width: 100%; min-height: 120px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 4px; font-family: var(--font-body); font-size: 11pt; line-height: 1.7; text-align: justify; }
    .chart-container { width: 100%; max-width: 400px; height: 300px; margin: 25px auto 0 auto; }
    .main-content-footer { display: flex; justify-content: space-between; border-top: 1px solid #e2e8f0; padding-top: 15px; font-family: var(--font-heading); font-size: 0.9em; flex-shrink: 0; }
    .text-content-for-pdf { font-family: var(--font-body); font-size: 11pt; line-height: 1.7; text-align: justify; white-space: pre-wrap; }
    @media print { .no-print { display: none !important; } }
</style>

<script>
    // --- Warnung bei ungespeicherten √Ñnderungen ---
    let isDirty = false;

    // Funktion, um den Zustand auf "ge√§ndert" zu setzen
    function setDirty() {
        isDirty = true;
    }

    // √úberwache alle Textareas
    document.querySelectorAll('textarea').forEach(item => {
        item.addEventListener('input', setDirty);
    });

    // √úberwache alle Content-Editable Felder
    document.querySelectorAll('[contenteditable="true"]').forEach(item => {
        item.addEventListener('input', setDirty);
    });
    
    // √úberwache alle Slider (input type=range)
    // Wir m√ºssen einen Moment warten, bis die Slider dynamisch erstellt wurden
    setTimeout(() => {
        document.querySelectorAll('input[type="range"]').forEach(item => {
            item.addEventListener('input', setDirty);
        });
    }, 1000);

    // Wenn der Nutzer versucht, die Seite zu verlassen, pr√ºfe den "dirty"-Status
    window.addEventListener('beforeunload', (event) => {
        if (isDirty) {
            // Zeige den Standard-Dialog des Browsers an
            event.preventDefault();
            event.returnValue = '';
        }
    });

    // --- Bestehende Speicher-Funktion anpassen ---
    // Wir "√ºberschreiben" die bestehende saveReport-Funktion, um den Status zur√ºckzusetzen
    const originalSaveReport = window.saveReport;
    window.saveReport = async function() {
        // Rufe die urspr√ºngliche Speicherfunktion auf
        await originalSaveReport();
        
        // Setze den Status nach erfolgreichem Speichern zur√ºck
        isDirty = false;
    };
</script>
{% endblock %}
