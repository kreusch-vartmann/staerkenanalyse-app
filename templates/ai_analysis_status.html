{% extends 'base.html' %}

{% block title %}Analyse-Status für {{ group.name }}{% endblock %}

{% block content %}
    <h2 class="text-3xl font-bold text-gray-800 mb-2">Analyse-Status für Gruppe: {{ group.name }}</h2>
    <p class="text-gray-600 mb-6">Die KI-Analyse wird für die folgenden Teilnehmer ausgeführt. Bitte schließen Sie dieses Fenster nicht.</p>

    <div class="bg-white border border-gray-200 rounded-lg shadow p-6">
        <div id="status-list" class="space-y-3">
            {% for p in participants %}
            <div id="status-{{ p.id }}" data-participant-id="{{ p.id }}" class="participant-row flex items-center justify-between p-3 rounded-md bg-gray-50">
                <span class="font-medium text-gray-800">{{ p.name }}</span>
                <span class="status-indicator text-gray-500 font-semibold">
                    <i class="fas fa-clock me-2"></i> Wartend
                </span>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="mt-8">
        <a id="finish-button" href="{{ url_for('show_group_participants', group_id=group.id) }}" class="hidden py-3 px-8 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold text-lg">
            <i class="fas fa-check-circle me-2"></i>Alle Berichte ansehen
        </a>
    </div>

    <script id="analysis-config" type="application/json">
        {{ analysis_data | tojson | safe }}
    </script>

    <script>
        const participantRows = document.querySelectorAll('.participant-row');
        // Die Konfiguration wird sicher aus dem Script-Tag ausgelesen
        const analysisConfig = JSON.parse(document.getElementById('analysis-config').textContent);

        async function runAnalysisForParticipant(participantRow) {
            const participantId = participantRow.dataset.participantId;
            const indicator = participantRow.querySelector('.status-indicator');

            try {
                indicator.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Wird analysiert...';
                indicator.className = 'status-indicator text-blue-600 font-semibold';

                const response = await fetch(`/api/run_single_analysis/${participantId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(analysisConfig)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    indicator.innerHTML = '<i class="fas fa-check-circle me-2"></i> Erfolgreich';
                    indicator.className = 'status-indicator text-green-600 font-semibold';
                    participantRow.classList.replace('bg-gray-50', 'bg-green-50');
                } else {
                    indicator.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i> Fehler: ${result.message}`;
                    indicator.className = 'status-indicator text-red-600 font-semibold';
                    participantRow.classList.replace('bg-gray-50', 'bg-red-50');
                }
            } catch (error) {
                indicator.innerHTML = '<i class="fas fa-times-circle me-2"></i> Netzwerkfehler';
                indicator.className = 'status-indicator text-red-600 font-semibold';
                participantRow.classList.replace('bg-gray-50', 'bg-red-50');
            }
        }

        async function startQueue() {
            for (const row of participantRows) {
                await runAnalysisForParticipant(row);
            }
            document.getElementById('finish-button').classList.remove('hidden');
        }

        document.addEventListener('DOMContentLoaded', startQueue);
    </script>
{% endblock %}