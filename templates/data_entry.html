{% extends 'base.html' %}

{% block title %}Dateneingabe für {{ participant.name }}{% endblock %}

{% block content %}
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-3xl font-bold text-gray-800">Dateneingabe</h2>
            <p class="text-lg text-gray-600">für <span class="font-semibold">{{ participant.name }}</span> in Gruppe <span class="font-semibold">{{ group.name }}</span></p>
        </div>
        <a href="{{ url_for('groups.show_group_participants', group_id=group.id) }}" class="py-2 px-4 text-sm rounded-lg bg-gray-200 hover:bg-gray-300 font-semibold">
            ← Zurück zur Gruppenübersicht
        </a>
    </div>

    <div class="bg-white p-8 rounded-lg shadow-md border border-gray-200">
        <h3 class="text-xl font-semibold text-gray-700 mb-3">Beobachtungen</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="social-observations" class="block mb-2 text-sm font-medium text-gray-900">Soziale Kompetenzen</label>
                <textarea id="social-observations" rows="8" class="w-full rounded-md border-gray-300 shadow-sm p-3">{{ (participant.observations or {}).social or '' }}</textarea>
            </div>
            <div>
                <label for="verbal-observations" class="block mb-2 text-sm font-medium text-gray-900">Verbale Kompetenzen</label>
                <textarea id="verbal-observations" rows="8" class="w-full rounded-md border-gray-300 shadow-sm p-3">{{ (participant.observations or {}).verbal or '' }}</textarea>
            </div>
        </div>
        <div class="pt-6 flex justify-end">
            <button type="button" onclick="saveObservations()" class="py-2 px-6 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold">
                Beobachtungen speichern
            </button>
        </div>
    </div>

    <div class="mt-10 bg-white p-8 rounded-lg shadow-md border border-gray-200">
        <h3 class="text-2xl font-bold text-gray-800 mb-4">Nächster Schritt</h3>
        <p class="text-gray-600 mb-4">Nachdem Sie die Beobachtungen gespeichert haben, können Sie die KI-Analyse für diesen Teilnehmer konfigurieren und starten.</p>
        
        <form action="{{ url_for('analysis.configure_batch_ai_analysis') }}" method="post">
            <input type="hidden" name="participant_ids" value="{{ participant.id }}">
            <button type="submit" class="py-2 px-6 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold">
                Analyse für {{ participant.name }} starten →
            </button>
        </form>
    </div>

    <script>
        async function saveObservations() {
            try {
                const dataToSend = {
                    social: document.getElementById('social-observations').value,
                    verbal: document.getElementById('verbal-observations').value
                };

                const response = await fetch(`{{ url_for('participants.save_observations', participant_id=participant.id) }}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });
                const result = await response.json();
                
                // Einfache Feedback-Meldung via alert
                alert(result.message);

            } catch (error) {
                console.error('Fehler in saveObservations:', error);
                alert('Speichern fehlgeschlagen. Prüfen Sie die Browser-Konsole für Details.');
            }
        }
    </script>

    <script>
        // --- Warnung bei ungespeicherten Änderungen ---
        let isDirty = false;
    
        // Funktion, um den Zustand auf "geändert" zu setzen
        function setDirty() {
            isDirty = true;
        }
    
        // Überwache die beiden Textareas
        document.getElementById('social-observations').addEventListener('input', setDirty);
        document.getElementById('verbal-observations').addEventListener('input', setDirty);
    
        // Wenn der Nutzer versucht, die Seite zu verlassen, prüfe den "dirty"-Status
        window.addEventListener('beforeunload', (event) => {
            if (isDirty) {
                // Zeige den Standard-Dialog des Browsers an
                event.preventDefault();
                event.returnValue = '';
            }
        });
    
        // --- Bestehende Speicher-Funktion anpassen ---
        // Wir "überschreiben" die bestehende saveObservations-Funktion, um den Status zurückzusetzen
        const originalSaveObservations = window.saveObservations;
        window.saveObservations = async function() {
            // Rufe die ursprüngliche Speicherfunktion auf
            const wasSuccessful = await originalSaveObservations();
            
            // Setze den Status NUR nach erfolgreichem Speichern zurück
            if (wasSuccessful) {
                isDirty = false;
            }
        };
    </script>
{% endblock %}
